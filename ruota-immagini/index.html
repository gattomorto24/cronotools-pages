<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ruota Immagini - CronoTools</title>
    
    <!-- Design System CSS -->
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>

    <!-- Dynamic Navbar -->
    <crono-navbar></crono-navbar>

    <div class="content-wrapper">
        <header class="main-header">
            <h1>Ruota</h1>
            <p class="description">Correggi l'orientamento delle tue foto. Ruota a destra, sinistra o capovolgi con un tocco.</p>
        </header>

        <main>
            <!-- Fase 1: Upload -->
            <div id="upload-stage" class="upload-area">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div class="upload-title">Tocca per caricare</div>
                <div class="upload-desc">JPG, PNG, WEBP supportati</div>
                <input type="file" id="file-input" accept="image/*" hidden>
            </div>

            <!-- Fase 2: Workspace -->
            <div id="workspace-stage" class="workspace-container">
                <div class="canvas-wrapper">
                    <canvas id="editor-canvas"></canvas>
                </div>

                <!-- Controls Toolbar -->
                <div class="toolbar-floating">
                    <button class="tool-btn" id="btn-undo" title="Annulla" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14L4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
                        Undo
                    </button>

                    <button class="tool-btn" id="btn-left" title="Ruota Sinistra">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        -90°
                    </button>

                    <button class="tool-btn" id="btn-right" title="Ruota Destra">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
                        +90°
                    </button>

                    <button class="tool-btn" id="btn-180" title="Capovolgi">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        180°
                    </button>

                    <button class="tool-btn danger" id="btn-reset" title="Chiudi">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        Esci
                    </button>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button id="btn-download" class="alert-btn primary" style="padding: 16px 32px; font-size: 18px; width: 100%; max-width: 300px;">Scarica Immagine</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Moduli JS -->
    <script src="../js/ui.js"></script>
    <script src="../js/core.js"></script>
    <script src="../components/navbar.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const engine = new CronoEngine('editor-canvas');
            const uploadArea = document.getElementById('upload-stage');
            const fileInput = document.getElementById('file-input');
            const workspace = document.getElementById('workspace-stage');
            
            // UI References
            const btnUndo = document.getElementById('btn-undo');
            const btnLeft = document.getElementById('btn-left');
            const btnRight = document.getElementById('btn-right');
            const btn180 = document.getElementById('btn-180');
            const btnReset = document.getElementById('btn-reset');
            const btnDownload = document.getElementById('btn-download');

            // --- Eventi Core ---
            engine.on('imageLoaded', () => {
                uploadArea.style.display = 'none';
                workspace.style.display = 'block';
            });

            engine.on('historyChange', ({ canUndo }) => {
                btnUndo.disabled = !canUndo;
            });

            // --- Gestione Upload ---
            uploadArea.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) engine.loadImage(e.target.files[0]);
            });

            ['dragover', 'dragleave', 'drop'].forEach(ev => {
                uploadArea.addEventListener(ev, (e) => {
                    e.preventDefault();
                    if (ev === 'dragover') uploadArea.classList.add('drag-over');
                    else uploadArea.classList.remove('drag-over');
                    if (ev === 'drop' && e.dataTransfer.files.length) engine.loadImage(e.dataTransfer.files[0]);
                });
            });

            // --- Pulsanti Tool ---
            btnLeft.addEventListener('click', () => engine.rotate(-90));
            btnRight.addEventListener('click', () => engine.rotate(90));
            btn180.addEventListener('click', () => engine.rotate(180));
            
            btnUndo.addEventListener('click', () => engine.undo());

            btnReset.addEventListener('click', () => {
                UI.showAlert(
                    'Attenzione', 
                    'Vuoi cancellare tutto e tornare alla home?', 
                    [
                        { text: 'Annulla', action: () => {} }, 
                        { text: 'Esci', class: 'danger', action: () => window.location.reload() }
                    ]
                );
            });

            btnDownload.addEventListener('click', async () => {
                const blob = await engine.export('png');
                engine.download(blob, 'crono-ruota.png');
            });
        });
    </script>
</body>
</html>