<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ritaglia Immagini - CronoTools</title>
    
    <!-- Path corretto per i file che sono nella root -->
    <link rel="stylesheet" href="../css/style.css">
    
    <!-- Libreria CropperJS (Lazy loaded per performance) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
</head>
<body>

    <crono-navbar></crono-navbar>

    <div class="content-wrapper">
        <header class="main-header">
            <h1>Ritaglia</h1>
            <p class="description">Adatta le tue immagini per social, web e stampa con precisione pixel-perfect.</p>
        </header>

        <main>
            <!-- Fase 1: Upload -->
            <div id="upload-stage" class="upload-area">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                <div class="upload-title">Tocca per caricare</div>
                <div class="upload-desc">o trascina un file qui (JPG, PNG, WEBP)</div>
                <input type="file" id="file-input" accept="image/*" hidden>
            </div>

            <!-- Fase 2: Workspace (Nascosto inizialmente) -->
            <div id="workspace-stage" class="workspace-container">
                <div class="canvas-wrapper">
                    <img id="image-target" style="max-width: 100%; display: block;">
                </div>

                <!-- Floating Toolbar iOS Style -->
                <div class="toolbar-floating">
                    <button class="tool-btn" id="btn-undo" title="Annulla" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14L4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
                        Undo
                    </button>
                    
                    <button class="tool-btn" id="btn-rotate" title="Ruota">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        Ruota
                    </button>

                     <button class="tool-btn" id="btn-aspect" title="Formato">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                        Ratio
                    </button>

                    <button class="tool-btn active" id="btn-crop" title="Applica">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2v14a2 2 0 0 0 2 2h14"/><path d="M18 22V8a2 2 0 0 0-2-2H2"/></svg>
                        Ritaglia
                    </button>

                    <button class="tool-btn danger" id="btn-reset" title="Chiudi">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        Esci
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="btn-download" class="alert-btn primary" style="padding: 16px 32px; font-size: 18px; width: 100%; max-width: 300px;">Scarica Immagine</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../js/ui.js"></script>
    <script src="../js/core.js"></script>
    <script src="../components/navbar.js"></script>
    
    <!-- Cropper Logic Specific -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('upload-stage');
            const fileInput = document.getElementById('file-input');
            const workspace = document.getElementById('workspace-stage');
            const imageTarget = document.getElementById('image-target');
            let cropper = null;

            // Handle Upload
            uploadArea.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(file) startCropper(file);
            });

            // Handle Drag & Drop
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                if(e.dataTransfer.files[0]) startCropper(e.dataTransfer.files[0]);
            });

            function startCropper(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageTarget.src = e.target.result;
                    uploadArea.style.display = 'none';
                    workspace.style.display = 'block';
                    
                    if(cropper) cropper.destroy();
                    
                    cropper = new Cropper(imageTarget, {
                        viewMode: 2,
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        background: false,
                        responsive: true,
                        restore: false,
                        ready() {
                            // Cropper is ready
                        }
                    });
                };
                reader.readAsDataURL(file);
            }

            // Toolbar Actions
            document.getElementById('btn-rotate').addEventListener('click', () => cropper.rotate(90));
            
            let aspectRatios = [NaN, 1, 16/9, 4/3];
            let aspectIndex = 0;
            document.getElementById('btn-aspect').addEventListener('click', () => {
                aspectIndex = (aspectIndex + 1) % aspectRatios.length;
                cropper.setAspectRatio(aspectRatios[aspectIndex]);
                UI.showAlert('Formato', aspectIndex === 0 ? 'Libero' : 'Fisso');
            });

            document.getElementById('btn-crop').addEventListener('click', () => {
                const canvas = cropper.getCroppedCanvas();
                imageTarget.src = canvas.toDataURL();
                cropper.destroy();
                cropper = new Cropper(imageTarget, { viewMode: 2 }); // Restart on cropped image
                // Add to history here (omitted for brevity)
            });

            document.getElementById('btn-reset').addEventListener('click', () => {
                if(confirm('Vuoi annullare tutto e tornare alla home?')) {
                    window.location.reload();
                }
            });

            document.getElementById('btn-download').addEventListener('click', () => {
                const canvas = cropper.getCroppedCanvas();
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'cronotools-ritaglio.png';
                    a.click();
                });
            });
        });
    </script>
</body>
</html>